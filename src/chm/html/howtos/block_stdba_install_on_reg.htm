<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="stylesheet" type="text/css" href="style.css" />
<title>How To: Block Bootstrapper Installation Based on Registry Key</title>
</head>
<body>
<h1>How To: Block Bootstrapper Installation Based on Registry Key</h1>

<p>In this example, the bootstrapper will install the 4.0 .Net Framework, if necessary, and then the specific application.
However, the application depends on a previous installation of third-party software. Ideally, the user wants to abort 
the installation and avoid a time-consuming .Net Framework install, if the software can't be used.  An existance check 
for a registry key, in this example, allows the install to abort if it's not found.  Here's how it's done:</p>

<p>The process requires both the WiX Util and the WiX Bal Extensions.  Reference the dll libraries from the bootstrapper 
project, and add the schema to the Wix element. (The .Net Framework extension is included merely as part of the example.)
The Wix element should look like this:</p>

<pre><code>    &lt;Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" 
         xmlns:util="http://schemas.microsoft.com/wix/UtilExtension" 
         xmlns:netfx="http://schemas.microsoft.com/wix/NetFxExtension" 
         xmlns:bal="http://schemas.microsoft.com/wix/BalExtension"&gt;
</code></pre>

<p>The util:RegistrySearch element defines a WiX variable, ThirdPartyCOMLibraryInstalled, that will be True when 
the key exists.</p>

<pre><code>   &lt;util:RegistrySearch
          Id='SearchForThirdParty' 
          Variable="ThirdPartyCOMLibraryInstalled" 
          Result="exists"
          Root="HKLM"
          Key="SOFTWARE\Classes\ThirdPartyId.Server\CLSID"/&gt;
</code></pre>

<p>The WiX variable, ThirdPartyCOMLibraryInstalled, is used as the bal:Condition check expression.  If False, 
the value of the 'Message' attribute is displayed, and the installation is aborted.</p>

<pre><code>    &lt;bal:Condition Message="ThirdParty Application COM Library Required."&gt;
        ThirdPartyCOMLibraryInstalled
    &lt;/bal:Condition&gt;
</code></pre>

<p>If the code is organized in a Fragment, as in this example, an element must be referenced from the 
Bundle to include it. The util:RegistrySearch element is referenced:</p>

<pre><code>    &lt;util:RegistrySearchRef Id='SearchForThirdParty' /&gt;
</code></pre>

<p>The complete Bundle illustrates the required elements in context.  </p>

<pre><code>    &lt;?xml version="1.0" encoding="UTF-8"?&gt;
    &lt;Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" 
         xmlns:util="http://schemas.microsoft.com/wix/UtilExtension" 
         xmlns:netfx="http://schemas.microsoft.com/wix/NetFxExtension" 
         xmlns:bal="http://schemas.microsoft.com/wix/BalExtension"&gt;
      &lt;Bundle Name="!(bind.packageName.MyApp)" 
              Version="!(bind.packageVersion.MyApp)" 
              Manufacturer="!(bind.packageManufacturer.MyApp)" 
              UpgradeCode="a07ce1d5-a7ed-4d89-a7ee-fb13a5dd69ba" 
              Copyright="Copyright (c) 2013 [Bundle/@Manufacturer]. All rights reserved."
              IconSourceFile="$(var.My_Application1.ProjectDir)MyCo.ico"&gt;
        &lt;Variable Name="InstallFolder" 
            Type="string" 
            Value="[ProgramFilesFolder]MyCo Systems\My_Application\"
        /&gt; 
        &lt;util:RegistrySearchRef Id='SearchForThirdParty' /&gt;     
        &lt;BootstrapperApplicationRef 
          Id="WixStandardBootstrapperApplication.HyperlinkLicense" &gt;
          &lt;bal:WixStandardBootstrapperApplication 
            LaunchTarget="[InstallFolder]My_Application.exe" 
            SuppressRepair="yes" 
            SuppressOptionsUI="yes"
            LicenseUrl=""
            LogoFile="Resources/MyCoLogoWt64.png"
          /&gt;
        &lt;/BootstrapperApplicationRef&gt;
        &lt;Chain&gt;
          &lt;PackageGroupRef Id="NetFx40Redist"/&gt;
          &lt;MsiPackage Id ="MyApp" 
            Vital="yes" 
            Name="My Application" 
            SourceFile="$(var.MyApp_Install.TargetDir)MyApp_Install.msi"&gt;
            &lt;MsiProperty Name="INSTALLLOCATION" Value="[InstallFolder]" /&gt;
          &lt;/MsiPackage&gt;
        &lt;/Chain&gt;
      &lt;/Bundle&gt;
      &lt;Fragment&gt;
        &lt;util:RegistrySearch
              Id='SearchForThirdParty' 
              Variable="ThirdPartyCOMLibraryInstalled" 
              Result="exists"
              Root="HKLM"
              Key="SOFTWARE\Classes\ThirdPartyId.Server\CLSID"/&gt;
        &lt;bal:Condition 
          Message="ThirdParty Application COM Library Required."&gt;
          ThirdPartyCOMLibraryInstalled
        &lt;/bal:Condition&gt;
      &lt;/Fragment&gt;
    &lt;/Wix&gt;
</code></pre></body>
</html>
